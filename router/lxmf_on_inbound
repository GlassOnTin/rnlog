#!/usr/bin/env python3
"""Process inbound LXMF messages, extract telemetry to SQLite."""
import sys, os, json, time, sqlite3
import RNS
import LXMF

DB_PATH = "/root/.lxmd/telemetry.db"

def open_db():
    db = sqlite3.connect(DB_PATH)
    db.execute("""CREATE TABLE IF NOT EXISTS telemetry (
        id INTEGER PRIMARY KEY,
        ts REAL,
        source TEXT,
        title TEXT,
        content TEXT,
        fields TEXT,
        raw_path TEXT
    )""")
    db.execute("CREATE INDEX IF NOT EXISTS idx_ts ON telemetry(ts)")
    db.execute("CREATE INDEX IF NOT EXISTS idx_source ON telemetry(source, ts)")
    db.commit()
    return db

def process_message(path):
    try:
        with open(path, "rb") as f:
            lxm = LXMF.LXMessage.unpack_from_file(f)

        if lxm is None:
            return

        source_hash = lxm.source_hash.hex() if lxm.source_hash else "unknown"
        timestamp = lxm.timestamp if lxm.timestamp else time.time()
        title = lxm.title_as_string() if hasattr(lxm, 'title_as_string') else str(lxm.title)
        content = lxm.content_as_string() if hasattr(lxm, 'content_as_string') else str(lxm.content)

        fields = lxm.get_fields() if hasattr(lxm, 'get_fields') else None
        fields_json = None
        if fields:
            fields_safe = {}
            for k, v in fields.items():
                if isinstance(v, bytes):
                    fields_safe[str(k)] = v.hex()
                else:
                    fields_safe[str(k)] = v
            fields_json = json.dumps(fields_safe, default=str)

        db = open_db()
        db.execute(
            "INSERT INTO telemetry (ts, source, title, content, fields, raw_path) VALUES (?, ?, ?, ?, ?, ?)",
            (timestamp, source_hash, title, content, fields_json, path)
        )
        db.commit()
        db.close()

    except Exception as e:
        with open("/tmp/lxmf_inbound.log", "a") as log:
            log.write(f"{time.time()}: Error processing {path}: {e}\n")

if __name__ == "__main__":
    if len(sys.argv) > 1:
        process_message(sys.argv[1])
